<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>배차 오더 분석 시스템</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #0066cc 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
        }
        
        .logo {
            background: #1e3c72;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            margin-right: 25px;
            font-weight: bold;
            font-size: 18px;
            text-align: center;
            min-width: 200px;
            box-shadow: 0 5px 15px rgba(30, 60, 114, 0.3);
        }
        
        .logo .company-name {
            font-size: 24px;
            margin-bottom: 5px;
            letter-spacing: 2px;
        }
        
        .logo .tagline {
            font-size: 12px;
            opacity: 0.9;
            font-weight: normal;
        }
        
        h1 {
            color: #1e3c72;
            margin: 0;
            font-size: 2.2em;
            text-shadow: none;
        }
        
        .tabs {
            display: flex;
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
            margin-bottom: 20px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.3);
            overflow: hidden;
        }
        
        .tab {
            flex: 1;
            padding: 18px 25px;
            text-align: center;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            border-right: 1px solid rgba(255,255,255,0.1);
        }
        
        .tab:last-child {
            border-right: none;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #0066cc 0%, #1e3c72 100%);
            box-shadow: 0 4px 15px rgba(0, 102, 204, 0.3);
            color: white;
        }
        
        .tab:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .tab-content {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: bold;
            margin-bottom: 8px;
            color: #555;
        }
        
        input, select, textarea {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #0066cc;
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #0066cc 0%, #1e3c72 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 102, 204, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 102, 204, 0.4);
        }
        
        .stats-grid {
            display: flex !important;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: space-between;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #0066cc 0%, #1e3c72 100%);
            padding: 20px;
            border-radius: 15px;
            color: white;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 102, 204, 0.3);
            transition: transform 0.3s ease;
            flex: 1 1 calc(20% - 12px);
            min-width: 180px;
            min-height: 110px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        @media (max-width: 1200px) {
            .stat-card {
                flex: 1 1 calc(33.333% - 10px);
            }
        }
        
        @media (max-width: 768px) {
            .stat-card {
                flex: 1 1 calc(50% - 8px);
            }
        }
        
        @media (max-width: 480px) {
            .stat-card {
                flex: 1 1 100%;
            }
            .stats-grid {
                flex-direction: column;
            }
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card h3 {
            font-size: 2.2em;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .stat-card p {
            font-size: 1em;
            opacity: 0.9;
            margin: 0;
            font-weight: 500;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: linear-gradient(135deg, #1e3c72 0%, #0066cc 100%);
            color: white;
            font-weight: bold;
        }
        
        tr:hover {
            background-color: #f8f9ff;
        }
        
        .delete-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .edit-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .edit-btn:hover {
            background: #218838;
        }
        
        .save-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .save-btn:hover {
            background: #0069d9;
        }
        
        .cancel-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .cancel-btn:hover {
            background: #5a6268;
        }
        
        .edit-input {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            width: 80px;
            font-size: 12px;
        }
        
        .edit-input-wide {
            width: 100px;
        }
        
        .edit-select {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            width: 120px;
            font-size: 12px;
        }
        
        .edit-input-memo {
            width: 200px;
            height: 60px;
            resize: vertical;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .export-section {
            text-align: center;
            margin-top: 30px;
            padding: 30px;
            background: linear-gradient(135deg, #0066cc 0%, #1e3c72 100%);
            border-radius: 15px;
            color: white;
        }
        
        .export-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 10px;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            background: white;
            color: #0066cc;
        }
        
        .filter-section {
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-group label {
            font-weight: bold;
            margin: 0;
            white-space: nowrap;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
            min-width: 150px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <div class="company-name">TAEYOUNGWIN</div>
                <div class="tagline">내일의 희망이 오늘을 만든 (주)태영윈</div>
            </div>
            <h1>🚚 배차 오더 분석 시스템</h1>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('input')">📝 데이터 입력</button>
            <button class="tab" onclick="showTab('analysis')">📊 통계 분석</button>
            <button class="tab" onclick="showTab('history')">📋 이력 관리</button>
        </div>
        
        <!-- 데이터 입력 탭 -->
        <div id="input" class="tab-content active">
            <h2 style="margin-bottom: 25px; color: #1e3c72;">일일 배차 오더 입력</h2>
            
            <form id="orderForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="date">날짜</label>
                        <input type="date" id="date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="branch">지사명</label>
                        <select id="branch" required>
                            <option value="">선택하세요</option>
                            <option value="청주지사">청주지사</option>
                            <option value="충주지사">충주지사</option>
                            <option value="천안지사">천안지사</option>
                            <option value="아산지사">아산지사</option>
                            <option value="서산지사">서산지사</option>
                            <option value="세종지사">세종지사</option>
                            <option value="남대전지사">남대전지사</option>
                            <option value="북대전지사">북대전지사</option>
                            <option value="대전영업팀센터">대전영업팀센터</option>
                            <option value="남양주지사">남양주지사</option>
                            <option value="익산지사">익산지사</option>
                            <option value="멀티커머스">멀티커머스</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="morningOrder">가오더 수량</label>
                        <input type="number" id="morningOrder" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="tempOrderTime">가오더 시간</label>
                        <input type="time" id="tempOrderTime" value="09:00">
                    </div>
                    
                    <div class="form-group">
                        <label for="confirmedOrder">확정오더 수량</label>
                        <input type="number" id="confirmedOrder" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirmedOrderTime">확정오더 시간</label>
                        <input type="time" id="confirmedOrderTime" value="15:00">
                    </div>
                    
                    <div class="form-group">
                        <label for="cancelled">취소된 오더</label>
                        <input type="number" id="cancelled" min="0" value="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="changed">변경된 오더</label>
                        <input type="number" id="changed" min="0" value="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="added">추가된 오더</label>
                        <input type="number" id="added" min="0" value="0">
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label for="memo">상세 메모</label>
                    <textarea id="memo" rows="3" placeholder="추가적인 상황이나 특이사항을 입력하세요"></textarea>
                </div>
                
                <button type="submit" class="btn" style="margin-top: 20px;">📊 데이터 저장</button>
            </form>
        </div>
        
        <!-- 통계 분석 탭 -->
        <div id="analysis" class="tab-content">
            <h2 style="margin-bottom: 25px; color: #1e3c72;">📈 통계 분석</h2>
            
            <!-- 통계 필터 섹션 -->
            <div class="filter-section">
                <div class="filter-group">
                    <label>기간 선택:</label>
                    <select id="statsPeriod" onchange="toggleStatsFilters()">
                        <option value="all">전체</option>
                        <option value="monthly">월별</option>
                        <option value="daily">일별</option>
                    </select>
                </div>
                <div class="filter-group" id="monthFilter" style="display: none;">
                    <label>월 선택:</label>
                    <input type="month" id="selectedMonth" onchange="updateStatistics()">
                </div>
                <div class="filter-group" id="dateFilter" style="display: none;">
                    <label>날짜 선택:</label>
                    <input type="date" id="selectedDate" onchange="updateStatistics()">
                </div>
                <div class="filter-group">
                    <label>지사 선택:</label>
                    <select id="statsBranch" onchange="updateStatistics()">
                        <option value="">전체 지사</option>
                        <option value="청주지사">청주지사</option>
                        <option value="충주지사">충주지사</option>
                        <option value="천안지사">천안지사</option>
                        <option value="아산지사">아산지사</option>
                        <option value="서산지사">서산지사</option>
                        <option value="세종지사">세종지사</option>
                        <option value="남대전지사">남대전지사</option>
                        <option value="북대전지사">북대전지사</option>
                        <option value="대전영업팀센터">대전영업팀센터</option>
                        <option value="남양주지사">남양주지사</option>
                        <option value="익산지사">익산지사</option>
                        <option value="멀티커머스">멀티커머스</option>
                    </select>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalOrders">0</h3>
                    <p>총 확정오더 수</p>
                </div>
                <div class="stat-card">
                    <h3 id="avgAccuracy">0%</h3>
                    <p>평균 정확률</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalCancelled">0</h3>
                    <p>총 취소 수</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalChanged">0</h3>
                    <p>총 변경 수</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalAdded">0</h3>
                    <p>총 추가 수</p>
                </div>
            </div>
            
            <h3 style="margin: 30px 0 15px 0; color: #1e3c72;">지사별 통계</h3>
            <table id="branchStatsTable">
                <thead>
                    <tr>
                        <th>지사명</th>
                        <th>총 확정오더</th>
                        <th>정확률</th>
                        <th>취소율</th>
                        <th>변경율</th>
                        <th>추가율</th>
                    </tr>
                </thead>
                <tbody id="branchStatsBody">
                </tbody>
            </table>
        </div>
        
        <!-- 이력 관리 탭 -->
        <div id="history" class="tab-content">
            <h2 style="margin-bottom: 25px; color: #1e3c72;">📋 입력 이력</h2>
            
            <!-- 이력 필터 섹션 -->
            <div class="filter-section">
                <div class="filter-group">
                    <label>기간 선택:</label>
                    <select id="historyPeriod" onchange="toggleHistoryFilters()">
                        <option value="all">전체</option>
                        <option value="monthly">월별</option>
                        <option value="daily">일별</option>
                    </select>
                </div>
                <div class="filter-group" id="historyMonthFilter" style="display: none;">
                    <label>월 선택:</label>
                    <input type="month" id="historySelectedMonth" onchange="filterHistory()">
                </div>
                <div class="filter-group" id="historyDateFilter" style="display: none;">
                    <label>날짜 선택:</label>
                    <input type="date" id="historySelectedDate" onchange="filterHistory()">
                </div>
                <div class="filter-group">
                    <label>지사 선택:</label>
                    <select id="filterBranch" onchange="filterHistory()">
                        <option value="">전체 지사</option>
                        <option value="청주지사">청주지사</option>
                        <option value="충주지사">충주지사</option>
                        <option value="천안지사">천안지사</option>
                        <option value="아산지사">아산지사</option>
                        <option value="서산지사">서산지사</option>
                        <option value="세종지사">세종지사</option>
                        <option value="남대전지사">남대전지사</option>
                        <option value="북대전지사">북대전지사</option>
                        <option value="대전영업팀센터">대전영업팀센터</option>
                        <option value="남양주지사">남양주지사</option>
                        <option value="익산지사">익산지사</option>
                        <option value="멀티커머스">멀티커머스</option>
                    </select>
                </div>
            </div>
            
            <table id="historyTable">
                <thead>
                    <tr>
                        <th>날짜</th>
                        <th>지사명</th>
                        <th>가오더수량</th>
                        <th>가오더시간</th>
                        <th>확정오더수량</th>
                        <th>확정오더시간</th>
                        <th>취소</th>
                        <th>변경</th>
                        <th>추가</th>
                        <th>정확률</th>
                        <th>메모</th>
                        <th>관리</th>
                    </tr>
                </thead>
                <tbody id="historyBody">
                </tbody>
            </table>
            
            <div class="export-section">
                <h3 style="margin-bottom: 20px;">📤 데이터 내보내기</h3>
                <p style="margin-bottom: 20px;">수집된 데이터를 다양한 형태로 내보낼 수 있습니다.</p>
                <button class="export-btn" onclick="exportToCSV()">CSV 파일로 내보내기</button>
                <button class="export-btn" onclick="exportToJSON()">JSON 파일로 내보내기</button>
                <button class="export-btn" onclick="printReport()">보고서 인쇄</button>
            </div>
        </div>
    </div>

    <script>
        let editingIndex = -1; // 현재 편집 중인 행의 인덱스
        
        // 수정 시작 함수
        function startEdit(index) {
            if (editingIndex !== -1) {
                alert('다른 항목을 편집 중입니다. 먼저 저장하거나 취소해주세요.');
                return;
            }
            
            editingIndex = index;
            const item = orderData[index];
            const row = document.querySelector(`tr[data-index="${index}"]`);
            
            if (!row) return;
            
            // 각 셀을 편집 가능한 입력 필드로 변경
            row.innerHTML = `
                <td><input type="date" value="${item.date}" class="edit-input-wide" id="edit-date-${index}"></td>
                <td>
                    <select class="edit-select" id="edit-branch-${index}">
                        <option value="청주지사" ${item.branch === '청주지사' ? 'selected' : ''}>청주지사</option>
                        <option value="충주지사" ${item.branch === '충주지사' ? 'selected' : ''}>충주지사</option>
                        <option value="천안지사" ${item.branch === '천안지사' ? 'selected' : ''}>천안지사</option>
                        <option value="아산지사" ${item.branch === '아산지사' ? 'selected' : ''}>아산지사</option>
                        <option value="서산지사" ${item.branch === '서산지사' ? 'selected' : ''}>서산지사</option>
                        <option value="세종지사" ${item.branch === '세종지사' ? 'selected' : ''}>세종지사</option>
                        <option value="남대전지사" ${item.branch === '남대전지사' ? 'selected' : ''}>남대전지사</option>
                        <option value="북대전지사" ${item.branch === '북대전지사' ? 'selected' : ''}>북대전지사</option>
                        <option value="대전영업팀센터" ${item.branch === '대전영업팀센터' ? 'selected' : ''}>대전영업팀센터</option>
                        <option value="남양주지사" ${item.branch === '남양주지사' ? 'selected' : ''}>남양주지사</option>
                        <option value="익산지사" ${item.branch === '익산지사' ? 'selected' : ''}>익산지사</option>
                        <option value="멀티커머스" ${item.branch === '멀티커머스' ? 'selected' : ''}>멀티커머스</option>
                    </select>
                </td>
                <td><input type="number" value="${item.morningOrder}" min="0" class="edit-input" id="edit-morning-${index}"></td>
                <td><input type="time" value="${item.tempOrderTime || ''}" class="edit-input" id="edit-temptime-${index}"></td>
                <td><input type="number" value="${item.confirmedOrder}" min="0" class="edit-input" id="edit-confirmed-${index}"></td>
                <td><input type="time" value="${item.confirmedOrderTime || ''}" class="edit-input" id="edit-confirmedtime-${index}"></td>
                <td><input type="number" value="${item.cancelled}" min="0" class="edit-input" id="edit-cancelled-${index}"></td>
                <td><input type="number" value="${item.changed}" min="0" class="edit-input" id="edit-changed-${index}"></td>
                <td><input type="number" value="${item.added}" min="0" class="edit-input" id="edit-added-${index}"></td>
                <td><span style="color: ${item.accuracy >= 90 ? '#28a745' : item.accuracy >= 70 ? '#ffc107' : '#dc3545'}">${item.accuracy}%</span></td>
                <td><textarea class="edit-input-memo" id="edit-memo-${index}" placeholder="메모 입력">${item.memo || ''}</textarea></td>
                <td>
                    <button class="save-btn" onclick="saveEdit(${index})">저장</button>
                    <button class="cancel-btn" onclick="cancelEdit(${index})">취소</button>
                </td>
            `;
        }
        
        // 수정 저장 함수
        function saveEdit(index) {
            const newDate = document.getElementById(`edit-date-${index}`).value;
            const newBranch = document.getElementById(`edit-branch-${index}`).value;
            const newMorning = parseInt(document.getElementById(`edit-morning-${index}`).value) || 0;
            const newConfirmed = parseInt(document.getElementById(`edit-confirmed-${index}`).value) || 0;
            const newCancelled = parseInt(document.getElementById(`edit-cancelled-${index}`).value) || 0;
            const newChanged = parseInt(document.getElementById(`edit-changed-${index}`).value) || 0;
            const newAdded = parseInt(document.getElementById(`edit-added-${index}`).value) || 0;
            const newTempTime = document.getElementById(`edit-temptime-${index}`).value;
            const newConfirmedTime = document.getElementById(`edit-confirmedtime-${index}`).value;
            const newMemo = document.getElementById(`edit-memo-${index}`).value;
            
            // 입력값 검증
            if (!newDate || !newBranch) {
                alert('날짜와 지사명은 필수 입력 항목입니다.');
                return;
            }
            
            // 동일한 날짜와 지사의 다른 데이터가 있는지 확인 (현재 편집 중인 항목 제외)
            const existingIndex = orderData.findIndex((item, idx) => 
                idx !== index && item.date === newDate && item.branch === newBranch
            );
            
            if (existingIndex !== -1) {
                alert('해당 날짜와 지사의 데이터가 이미 존재합니다.');
                return;
            }
            
            // 정확률 계산 (수정된 공식 적용)
            const newAccuracy = calculateAccuracy(newMorning, newConfirmed, newCancelled, newChanged);
            
            // 추가된 오더 자동 계산
            const autoAdded = Math.max(0, newConfirmed - newMorning);
            const finalAdded = Math.max(newAdded, autoAdded);
            
            // 데이터 업데이트
            orderData[index] = {
                ...orderData[index],
                date: newDate,
                branch: newBranch,
                morningOrder: newMorning,
                confirmedOrder: newConfirmed,
                cancelled: newCancelled,
                changed: newChanged,
                added: finalAdded,
                tempOrderTime: newTempTime,
                confirmedOrderTime: newConfirmedTime,
                memo: newMemo,
                accuracy: newAccuracy
            };
            
            // 로컬 스토리지에 저장
            try {
                localStorage.setItem('orderData', JSON.stringify(orderData));
                console.log('수정된 데이터 저장 완료:', orderData[index]); // 디버깅용
                
                // 편집 모드 종료
                editingIndex = -1;
                
                // 테이블 새로고침
                filterHistory();
                updateStatistics();
                
                alert('데이터가 성공적으로 수정되었습니다!');
            } catch (error) {
                console.error('수정 저장 오류:', error);
                alert('데이터 수정 중 오류가 발생했습니다: ' + error.message);
            }
        }
        
        // 수정 취소 함수
        function cancelEdit(index) {
            editingIndex = -1;
            filterHistory(); // 원래 상태로 되돌리기
        }
        
        // 오늘 날짜를 기본값으로 설정
        document.getElementById('date').value = new Date().toISOString().split('T')[0];
        
        // 탭 전환 함수
        function showTab(tabName) {
            // 모든 탭과 컨텐츠 비활성화
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // 선택된 탭과 컨텐츠 활성화
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // 통계 분석 탭이 활성화되면 통계 업데이트
            if (tabName === 'analysis') {
                updateStatistics();
            }
            
            // 이력 관리 탭이 활성화되면 이력 업데이트
            if (tabName === 'history') {
                updateHistory();
            }
        }
        
        // 폼 제출 처리
        document.getElementById('orderForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // 입력값 가져오기
            const dateValue = document.getElementById('date').value;
            const branchValue = document.getElementById('branch').value;
            const morningOrderValue = document.getElementById('morningOrder').value;
            const confirmedOrderValue = document.getElementById('confirmedOrder').value;
            const cancelledValue = document.getElementById('cancelled').value;
            const changedValue = document.getElementById('changed').value;
            const addedValue = document.getElementById('added').value;
            const tempOrderTimeValue = document.getElementById('tempOrderTime').value;
            const confirmedOrderTimeValue = document.getElementById('confirmedOrderTime').value;
            const memoValue = document.getElementById('memo').value;
            
            // 입력값 검증
            if (!dateValue || !branchValue || !morningOrderValue || !confirmedOrderValue) {
                alert('날짜, 지사명, 가오더 수량, 확정오더 수량은 필수 입력 항목입니다.');
                return;
            }
            
            const morningOrder = parseInt(morningOrderValue) || 0;
            const confirmedOrder = parseInt(confirmedOrderValue) || 0;
            const cancelled = parseInt(cancelledValue) || 0;
            const changed = parseInt(changedValue) || 0;
            const added = parseInt(addedValue) || 0;
            
            // 추가된 오더 자동 계산 (확정오더가 가오더보다 많을 때)
            const autoAdded = Math.max(0, confirmedOrder - morningOrder);
            const finalAdded = Math.max(added, autoAdded); // 입력값과 자동계산값 중 큰 값 사용
            
            const formData = {
                date: dateValue,
                branch: branchValue,
                morningOrder: morningOrder,
                confirmedOrder: confirmedOrder,
                cancelled: cancelled,
                changed: changed,
                added: finalAdded,
                tempOrderTime: tempOrderTimeValue,
                confirmedOrderTime: confirmedOrderTimeValue,
                memo: memoValue,
                accuracy: calculateAccuracy(morningOrder, confirmedOrder, cancelled, changed)
            };
            
            console.log('저장할 데이터:', formData); // 디버깅용
            console.log('정확률 계산:', `가오더 ${morningOrder}, 확정오더 ${confirmedOrder}, 취소 ${cancelled}, 변경 ${changed}, 추가 ${finalAdded} → 정확률 ${formData.accuracy}%`); // 디버깅용
            
            // 동일한 날짜와 지사의 기존 데이터 확인
            const existingIndex = orderData.findIndex(item => 
                item.date === formData.date && item.branch === formData.branch
            );
            
            if (existingIndex !== -1) {
                if (confirm('해당 날짜와 지사의 데이터가 이미 존재합니다. 덮어쓰시겠습니까?')) {
                    orderData[existingIndex] = formData;
                } else {
                    return;
                }
            } else {
                orderData.push(formData);
            }
            
            // 로컬 스토리지에 저장
            try {
                localStorage.setItem('orderData', JSON.stringify(orderData));
                console.log('데이터 저장 완료:', orderData); // 디버깅용
                alert('데이터가 성공적으로 저장되었습니다!');
                
                // 폼 초기화
                this.reset();
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
                document.getElementById('tempOrderTime').value = '09:00';
                document.getElementById('confirmedOrderTime').value = '15:00';
                
            } catch (error) {
                console.error('저장 오류:', error);
                alert('데이터 저장 중 오류가 발생했습니다: ' + error.message);
            }
        });
        
        // 정확률 계산 함수 (수정된 공식: 변동이 적을수록 높은 정확률)
        function calculateAccuracy(morning, confirmed, cancelled, changed) {
            if (morning === 0) return 0;
            
            // 변동량 계산 (취소 + 변경 + 추가)
            const added = confirmed > morning ? confirmed - morning : 0; // 추가된 오더
            const totalVariation = cancelled + changed + added;
            
            // 정확률 = (가오더 - 총변동량) / 가오더 * 100
            // 단, 최소 0%, 최대 100%로 제한
            const accuracy = Math.max(0, Math.min(100, Math.round(((morning - totalVariation) / morning) * 100)));
            
            return accuracy;
        }
        
        // 통계 필터 토글 함수
        function toggleStatsFilters() {
            const period = document.getElementById('statsPeriod').value;
            const monthFilter = document.getElementById('monthFilter');
            const dateFilter = document.getElementById('dateFilter');
            
            if (period === 'monthly') {
                monthFilter.style.display = 'flex';
                dateFilter.style.display = 'none';
                document.getElementById('selectedMonth').value = new Date().toISOString().slice(0, 7);
            } else if (period === 'daily') {
                monthFilter.style.display = 'none';
                dateFilter.style.display = 'flex';
                document.getElementById('selectedDate').value = new Date().toISOString().split('T')[0];
            } else {
                monthFilter.style.display = 'none';
                dateFilter.style.display = 'none';
            }
            updateStatistics();
        }
        
        // 이력 필터 토글 함수
        function toggleHistoryFilters() {
            const period = document.getElementById('historyPeriod').value;
            const monthFilter = document.getElementById('historyMonthFilter');
            const dateFilter = document.getElementById('historyDateFilter');
            
            if (period === 'monthly') {
                monthFilter.style.display = 'flex';
                dateFilter.style.display = 'none';
                document.getElementById('historySelectedMonth').value = new Date().toISOString().slice(0, 7);
            } else if (period === 'daily') {
                monthFilter.style.display = 'none';
                dateFilter.style.display = 'flex';
                document.getElementById('historySelectedDate').value = new Date().toISOString().split('T')[0];
            } else {
                monthFilter.style.display = 'none';
                dateFilter.style.display = 'none';
            }
            filterHistory();
        }
        
        // 통계 업데이트 함수 (필터 적용)
        function updateStatistics() {
            const period = document.getElementById('statsPeriod').value;
            const selectedMonth = document.getElementById('selectedMonth').value;
            const selectedDate = document.getElementById('selectedDate').value;
            const selectedBranch = document.getElementById('statsBranch').value;
            
            // 필터링된 데이터 생성
            let filteredData = [...orderData];
            
            // 기간 필터 적용
            if (period === 'monthly' && selectedMonth) {
                filteredData = filteredData.filter(item => item.date.startsWith(selectedMonth));
            } else if (period === 'daily' && selectedDate) {
                filteredData = filteredData.filter(item => item.date === selectedDate);
            }
            
            // 지사 필터 적용
            if (selectedBranch) {
                filteredData = filteredData.filter(item => item.branch === selectedBranch);
            }
            
            if (filteredData.length === 0) {
                document.getElementById('totalOrders').textContent = '0';
                document.getElementById('avgAccuracy').textContent = '0%';
                document.getElementById('totalCancelled').textContent = '0';
                document.getElementById('totalChanged').textContent = '0';
                document.getElementById('totalAdded').textContent = '0';
                document.getElementById('branchStatsBody').innerHTML = '<tr><td colspan="6">해당 조건의 데이터가 없습니다</td></tr>';
                return;
            }
            
            // 전체 통계 계산 (확정오더 기준으로 변경)
            const totalOrders = filteredData.reduce((sum, item) => sum + (item.confirmedOrder || 0), 0);
            const totalCancelled = filteredData.reduce((sum, item) => sum + (item.cancelled || 0), 0);
            const totalChanged = filteredData.reduce((sum, item) => sum + (item.changed || 0), 0);
            const totalAdded = filteredData.reduce((sum, item) => sum + (item.added || 0), 0);
            
            console.log('통계 계산:', { totalOrders, totalCancelled, totalChanged, totalAdded }); // 디버깅용
            
            const avgAccuracy = Math.round(filteredData.reduce((sum, item) => sum + (item.accuracy || 0), 0) / filteredData.length);
            
            document.getElementById('totalOrders').textContent = totalOrders.toLocaleString();
            document.getElementById('avgAccuracy').textContent = avgAccuracy + '%';
            document.getElementById('totalCancelled').textContent = totalCancelled.toLocaleString();
            document.getElementById('totalChanged').textContent = totalChanged.toLocaleString();
            document.getElementById('totalAdded').textContent = totalAdded.toLocaleString();
            
            // 지사별 통계 계산
            const branchStats = {};
            filteredData.forEach(item => {
                if (!branchStats[item.branch]) {
                    branchStats[item.branch] = {
                        totalOrders: 0,
                        totalConfirmed: 0,
                        totalCancelled: 0,
                        totalChanged: 0,
                        totalAdded: 0,
                        accuracySum: 0,
                        count: 0
                    };
                }
                
                const stats = branchStats[item.branch];
                stats.totalOrders += (item.morningOrder || 0); // 가오더 기준
                stats.totalConfirmed += (item.confirmedOrder || 0);
                stats.totalCancelled += (item.cancelled || 0);
                stats.totalChanged += (item.changed || 0);
                stats.totalAdded += (item.added || 0);
                stats.accuracySum += (item.accuracy || 0);
                stats.count += 1;
            });
            
            // 지사별 통계 테이블 업데이트
            const tbody = document.getElementById('branchStatsBody');
            tbody.innerHTML = '';
            
            Object.entries(branchStats).forEach(([branch, stats]) => {
                const avgAccuracy = Math.round(stats.accuracySum / stats.count);
                const cancelRate = stats.totalOrders > 0 ? Math.round((stats.totalCancelled / stats.totalOrders) * 100) : 0;
                const changeRate = stats.totalOrders > 0 ? Math.round((stats.totalChanged / stats.totalOrders) * 100) : 0;
                const addRate = stats.totalOrders > 0 ? Math.round((stats.totalAdded / stats.totalOrders) * 100) : 0;
                
                console.log(`${branch} 통계:`, stats); // 디버깅용
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${branch}</strong></td>
                    <td>${stats.totalConfirmed.toLocaleString()}</td>
                    <td><span style="color: ${avgAccuracy >= 90 ? '#28a745' : avgAccuracy >= 70 ? '#ffc107' : '#dc3545'}">${avgAccuracy}%</span></td>
                    <td>${cancelRate}%</td>
                    <td>${changeRate}%</td>
                    <td>${addRate}%</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // 이력 필터링 함수 (개선된 버전)
        function filterHistory() {
            const period = document.getElementById('historyPeriod').value;
            const selectedMonth = document.getElementById('historySelectedMonth').value;
            const selectedDate = document.getElementById('historySelectedDate').value;
            const selectedBranch = document.getElementById('filterBranch').value;
            
            // 필터링된 데이터 생성
            let filteredData = [...orderData];
            
            // 기간 필터 적용
            if (period === 'monthly' && selectedMonth) {
                filteredData = filteredData.filter(item => item.date.startsWith(selectedMonth));
            } else if (period === 'daily' && selectedDate) {
                filteredData = filteredData.filter(item => item.date === selectedDate);
            }
            
            // 지사 필터 적용
            if (selectedBranch) {
                filteredData = filteredData.filter(item => item.branch === selectedBranch);
            }
            
            // 테이블 업데이트
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = '';
            
            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12">해당 조건의 데이터가 없습니다</td></tr>';
                return;
            }
            
            // 날짜순으로 정렬 (최신순)
            const sortedData = filteredData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedData.forEach((item, displayIndex) => {
                const originalIndex = orderData.indexOf(item);
                const row = document.createElement('tr');
                row.setAttribute('data-index', originalIndex);
                row.innerHTML = `
                    <td>${item.date}</td>
                    <td>${item.branch}</td>
                    <td>${item.morningOrder}</td>
                    <td>${item.tempOrderTime || '-'}</td>
                    <td>${item.confirmedOrder}</td>
                    <td>${item.confirmedOrderTime || '-'}</td>
                    <td>${item.cancelled}</td>
                    <td>${item.changed}</td>
                    <td>${item.added}</td>
                    <td><span style="color: ${item.accuracy >= 90 ? '#28a745' : item.accuracy >= 70 ? '#ffc107' : '#dc3545'}">${item.accuracy}%</span></td>
                    <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${item.memo || ''}">${item.memo || '-'}</td>
                    <td>
                        <button class="edit-btn" onclick="startEdit(${originalIndex})">수정</button>
                        <button class="delete-btn" onclick="deleteRecord(${originalIndex})">삭제</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // 이력 업데이트 함수 (기본 전체 이력 표시)
        function updateHistory() {
            filterHistory(); // 필터 함수를 사용하여 전체 이력 표시
        }
        
        // 레코드 삭제 함수
        function deleteRecord(index) {
            if (editingIndex !== -1) {
                alert('편집 중인 항목이 있습니다. 먼저 저장하거나 취소해주세요.');
                return;
            }
            
            if (confirm('정말로 이 데이터를 삭제하시겠습니까?')) {
                orderData.splice(index, 1);
                localStorage.setItem('orderData', JSON.stringify(orderData));
                updateHistory();
                updateStatistics(); // 통계도 함께 업데이트
                alert('데이터가 삭제되었습니다.');
            }
        }
        
        // CSV 내보내기 함수
        function exportToCSV() {
            if (orderData.length === 0) {
                alert('내보낼 데이터가 없습니다.');
                return;
            }
            
            let csv = '날짜,지사명,가오더수량,가오더시간,확정오더수량,확정오더시간,취소,변경,추가,정확률,메모\n';
            orderData.forEach(item => {
                csv += `${item.date},${item.branch},${item.morningOrder},${item.tempOrderTime || ''},${item.confirmedOrder},${item.confirmedOrderTime || ''},${item.cancelled},${item.changed},${item.added},${item.accuracy}%,${item.memo || ''}\n`;
            });
            
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `배차오더_분석_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }
        
        // JSON 내보내기 함수
        function exportToJSON() {
            if (orderData.length === 0) {
                alert('내보낼 데이터가 없습니다.');
                return;
            }
            
            const blob = new Blob([JSON.stringify(orderData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `배차오더_데이터_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }
        
        // 보고서 인쇄 함수
        function printReport() {
            window.print();
        }
        
        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('페이지 로드됨'); // 디버깅용
            
            // 로컬 스토리지에서 데이터 로드
            try {
                const savedData = localStorage.getItem('orderData');
                if (savedData) {
                    orderData = JSON.parse(savedData);
                    console.log('저장된 데이터 로드됨:', orderData); // 디버깅용
                }
            } catch (error) {
                console.error('데이터 로드 오류:', error);
                orderData = [];
            }
            
            // 오늘 날짜를 기본값으로 설정
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            
            // 현재 월과 날짜를 기본값으로 설정
            const today = new Date();
            const currentMonth = today.toISOString().slice(0, 7);
            const currentDate = today.toISOString().split('T')[0];
            
            document.getElementById('selectedMonth').value = currentMonth;
            document.getElementById('selectedDate').value = currentDate;
            document.getElementById('historySelectedMonth').value = currentMonth;
            document.getElementById('historySelectedDate').value = currentDate;
            
            // 시간 기본값 설정
            document.getElementById('tempOrderTime').value = '09:00';
            document.getElementById('confirmedOrderTime').value = '15:00';
            
            updateStatistics();
            updateHistory();
        });
    </script>
</body>
</html>